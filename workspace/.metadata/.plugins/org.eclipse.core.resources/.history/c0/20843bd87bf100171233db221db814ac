package monitor;

import archivos.Matriz;

public class GestorMonitor {
	
	private Mutex mutex;
	private RdP rdp;
	private Colas colas;
	private Politicas politicas;
	private Matriz m;
	private int disp;
	
	public GestorMonitor() {
		mutex = new Mutex();
		rdp = new RdP();
		colas = new Colas(rdp.getTrans());
		politicas = new Politicas();
		m = new Matriz(1, rdp.getTrans());
		disp = 0;
	}
	
	public void dispararTransicion(int t) {
		//System.out.print("Tamaño1: " + mutex.size() + "\n");
			//System.out.print("Antes acquire: " + mutex.permisos() + " " + Thread.currentThread().getName() + " T: " + t + "\n");
			//System.out.print("Tamaño2: " + mutex.size() + "\n");
			mutex.adquirirMutex();
			//System.out.print("Despues acquire: " + mutex.permisos() + " " + Thread.currentThread().getName() + " T: " + t + "\n");
			while (!rdp.disparar(t)) {
				//System.out.print("Dentro while: " + mutex.permisos() + " " + Thread.currentThread().getName() + " T: " + t + "\n");
				mutex.liberarMutex();
				if (rdp.getVentana() > 0 && rdp.getVectorSencibilizadas().getValor(0, t) == 1) {
					//System.out.print("A dormir: " + mutex.permisos() + " " + Thread.currentThread().getName() + " T: " + t + "\n");
					try { Thread.sleep(rdp.getVentana()); mutex.adquirirMutex(); }
					catch (InterruptedException e) { e.printStackTrace(); } }
				else
					{ colas.adquirirCola(t); }
			}

			System.out.print(disp++ + ". T: " + t +"\n");
			Matriz vs = rdp.getVectorSencibilizadas();
			Matriz vc = colas.quienesEstan();
			System.out.print("vs: " + vs.toString());
			System.out.print("vc: " + vc.toString());

			m = vs.and(vc);
			System.out.print("m : " + m.toString());
			if (!m.esCero()) { colas.liberarHilo(politicas.cual(m)); }
			else { mutex.liberarMutex(); }
	}	
	/*
	 *  ####################### MONITOR SIN TIEMPO ########################
	 * 
		public void dispararTransicion(int t) throws InterruptedException {

			mutex.adquirirMutex();
			while (!rdp.shoot(t)) {				
				mutex.liberarMutex();
				colas.adquirirCola(t);
			}
				
			System.out.print(disp++ + ". T: " + t +"\n");
			Matriz vs = rdp.getSencib();
			Matriz vc = colas.quienesEstan();
			
			m = vs.and(vc);
			if (!m.esCero())
				colas.liberarHilo(politicas.cual(m));
			
			mutex.liberarMutex();
	*/
	/*
	 mutex.adquirirMutex();
		k = true;
		
		hilo: {
			while (k == true) {
				k = rdp.shoot(t);
				
				if (k == true) {
					System.out.print(disp++ + ". T: " + t +"\n");
					Matriz vs = rdp.getSencib();
					Matriz vc = colas.quienesEstan();
					
					m = vs.and(vc);
					
					if (!m.esCero()) {
						colas.liberarHilo(politicas.cual(m));
						break hilo; 
					}
					else { k = false; }	
				}
				else {
					System.out.print("NoSenc: " + t + "\n");
					mutex.liberarMutex();
					System.out.print("Encolo: " + t + "\n");
					colas.adquirirCola(t);
				}
			}
			mutex.liberarMutex();
		}
	}*/
}
